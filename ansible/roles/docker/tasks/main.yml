---
# 🧪 Check if Docker is installed (runs for all environments)
- name: 🐳 Check if Docker is installed
  command: docker --version
  register: docker_check
  changed_when: false
  failed_when: docker_check.rc != 0

# 🔧 Local-only Docker sanity check
- name: ✅ Confirm Docker is available (local)
  debug:
    msg: "Docker is available on your local machine."
  when: env_name == "local"

# 🏗️ Prod-only Docker install
- name: 🐳 Install Docker (prod only)
  block:
    - name: 🧼 Ensure apt is updated
      apt:
        update_cache: yes

    - name: ➕ Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: 🔐 Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: 📦 Add Docker apt repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: 📥 Install Docker and Compose plugin
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: latest

    - name: 👤 Add user to docker group
      user:
        name: "{{ ansible_user | default('ubuntu') }}"
        groups: docker
        append: yes
  when: env_name == "prod"
