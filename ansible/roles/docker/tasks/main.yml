---
# ğŸ§ª Check if Docker is installed (runs for all environments)
- name: ğŸ³ Check if Docker is installed
  command: docker --version
  register: docker_check
  changed_when: false
  failed_when: docker_check.rc != 0

# ğŸ”§ Local-only Docker sanity check
- name: âœ… Confirm Docker is available (local)
  debug:
    msg: "Docker is available on your local machine."
  when: env_name == "local"

# ğŸ—ï¸ Prod-only Docker install
- name: ğŸ³ Install Docker (prod only)
  block:
    - name: ğŸ§¼ Ensure apt is updated
      apt:
        update_cache: yes

    - name: â• Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: ğŸ” Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: ğŸ“¦ Add Docker apt repo
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: ğŸ“¥ Install Docker and Compose plugin
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: latest

    - name: ğŸ‘¤ Add user to docker group
      user:
        name: "{{ ansible_user | default('ubuntu') }}"
        groups: docker
        append: yes
  when: env_name == "prod"
