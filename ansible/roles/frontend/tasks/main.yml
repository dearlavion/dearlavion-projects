# ====================
# Frontend + Nginx (macOS)
# ====================

- name: Ensure Homebrew is installed
  shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  args:
    creates: /opt/homebrew/bin/brew
  become: false
  tags: ["start"]

- name: Ensure Node.js installed via Homebrew
  homebrew:
    name: node
    state: present
  become: false
  tags: ["start"]

- name: Install Angular CLI globally
  command: yarn global add @angular/cli
  become: false
  tags: ["start"]

- name: Install project dependencies
  command: yarn install
  args:
    chdir: "{{ ui_project_path }}"
  become: false
  tags: ["start"]

- name: Build Angular app (production)
  command: yarn run build -- --configuration production
  args:
    chdir: "{{ ui_project_path }}"
  become: false
  tags: ["start"]

- name: Ensure nginx installed via Homebrew
  homebrew:
    name: nginx
    state: present
  become: false
  tags: ["start"]

# --- Directory setup for Nginx and Web Root ---
- name: Ensure nginx run directory exists
  file:
    path: /opt/homebrew/var/run/nginx
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: admin
    recurse: yes
  become: true
  tags: ["start"]

- name: Ensure nginx web root exists
  file:
    path: /opt/homebrew/var/www/dearlavion
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: admin
    recurse: yes
  become: true
  tags: ["start"]

- name: Ensure nginx log directory exists
  file:
    path: /opt/homebrew/var/log/nginx
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: admin
    recurse: yes
  become: true
  tags: ["start"]

# --- Clean Nginx web root before deploying new build ---
- name: Remove all existing files from Nginx web root
  file:
    path: "/opt/homebrew/var/www/dearlavion/*"
    state: absent
  become: true
  tags: ["start"]
  ignore_errors: yes

# --- Deploy Angular build ---
- name: Copy built UI to nginx folder
  synchronize:
    src: "{{ ui_project_path }}/dist/dearlavion-web-ui/"
    dest: "/opt/homebrew/var/www/dearlavion/"
    recursive: yes
  become: true
  tags: ["start"]

# --- Deploy Nginx configuration ---
- name: Deploy nginx configuration
  template:
    src: "nginx-frontend.conf.j2"
    dest: "/opt/homebrew/etc/nginx/servers/dearlavion.conf"
  become: false
  tags: ["start"]

- name: Test nginx configuration
  command: nginx -t
  become: true
  tags: ["start"]

# --- Start/restart nginx safely ---
- name: Stop nginx service if running
  shell: brew services stop nginx || true
  become: false
  tags: ["start"]

- name: Ensure nginx.pid is owned by the current user
  file:
    path: /opt/homebrew/var/run/nginx/nginx.pid
    owner: "{{ ansible_user }}"
    group: admin
    state: file
  become: true
  tags: ["start"]
  ignore_errors: yes  # in case PID doesn't exist yet

- name: Start nginx manually
  shell: nginx -c /opt/homebrew/etc/nginx/nginx.conf
  become: false
  tags: ["start"]

# --- Stop nginx service ---
- name: Stop nginx service
  shell: brew services stop nginx
  become: false
  tags: ["stop"]

- name: Stop any nginx processes
  shell: pkill nginx || true
  become: false
  tags: ["stop"]
