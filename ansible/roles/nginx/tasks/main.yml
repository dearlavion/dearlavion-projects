- name: Stop host nginx if running
  become: true
  service:
    name: nginx
    state: stopped
    enabled: false
  ignore_errors: true

- name: Ensure project directories exist
  become: true
  file:
    path: /opt/dearlavion/nginx
    state: directory
    mode: "0755"

- name: Copy nginx.conf
  become: true
  copy:
    src: nginx/nginx.conf
    dest: /opt/dearlavion/nginx/nginx.conf

- name: Deploy site config
  become: true
  template:
    src: nginx/dearlavion-app.conf.j2
    dest: /opt/dearlavion/nginx/dearlavion-app.conf

- name: Ensure certbot is installed
  become: true
  apt:
    name: certbot
    state: present
    update_cache: true

- name: Obtain SSL certificate from Let's Encrypt
  become: true
  command: >
    certbot certonly --nginx
    --non-interactive
    --agree-tos
    {% for domain in server_names %}-d {{ domain }} {% endfor %}
    -m {{ email }}
  args:
    creates: "/etc/letsencrypt/live/{{ server_names[0] }}/fullchain.pem"

- name: Deploy docker-compose file
  become: true
  template:
    src: docker-compose.yml.j2
    dest: /opt/dearlavion/docker-compose.yml

- name: Start Docker stack
  become: true
  community.docker.docker_compose_v2:
    project_src: /opt/dearlavion
    state: present
