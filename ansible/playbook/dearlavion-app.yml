- name: Setup DearLavion App DEV environment (Ubuntu)
  hosts: dearlavion-app_{{ env }}
  become: false
  gather_facts: yes
  roles_path: ../roles

  tasks:
    # ----------------------------
    # Load env-specific variables
    # ----------------------------
    - name: Load environment-specific variables
      include_vars:
        file: "../group_vars/dearlavion-app_{{ env }}.yml"

    # ----------------------------
    # Passwordless sudo
    # ----------------------------
    - name: Ensure baish has passwordless sudo
      become: true
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^baish ALL=.*NOPASSWD:ALL'
        line: 'baish ALL=(ALL) NOPASSWD:ALL'
        validate: '/usr/sbin/visudo -cf %s'

    # ----------------------------
    # System packages
    # ----------------------------
    - name: Update apt cache
      become: true
      apt:
        update_cache: yes

    - name: Ensure Python3 and pip3 are installed
      become: true
      apt:
        name:
          - python3
          - python3-pip
        state: present

    # ----------------------------
    # Docker
    # ----------------------------
    - name: Ensure Docker is installed
      become: true
      apt:
        name: docker.io
        state: present

    - name: Add user to docker group
      become: true
      user:
        name: baish
        groups: docker
        append: yes

    # ----------------------------
    # Docker Compose v2
    # ----------------------------
    - name: Install Docker Compose CLI plugin (v2)
      become: true
      shell: |
        mkdir -p /usr/local/lib/docker/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64 \
          -o /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
      args:
        creates: /usr/local/lib/docker/cli-plugins/docker-compose

    # ----------------------------
    # Docker network for inter-container communication
    # ----------------------------
    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: dearlavion-net
        state: present

    # ----------------------------
    # Log in to GHCR on DEV server
    # ----------------------------
    - name: Log in to GHCR
      community.docker.docker_login:
        registry_url: ghcr.io
        username: baish
        password: "{{ ghcr_pat }}"

    # ----------------------------
    # Pull & run services from GHCR
    # ----------------------------
    - name: Pull and run Authentication Service
      community.docker.docker_container:
        name: dearlavion-authentication-service
        image: ghcr.io/dearlavion/dearlavion-auth-service:dev
        state: started
        restart_policy: always
        networks:
          - name: dearlavion-net
      when: deploy_service == "auth" and (use_registry | bool)

    - name: Pull and run Core Service
      community.docker.docker_container:
        name: dearlavion-core-service
        image: ghcr.io/dearlavion/dearlavion-core-service:dev
        state: started
        restart_policy: always
        networks:
          - name: dearlavion-net
      when: deploy_service == "core" and (use_registry | bool)

    - name: Pull and run Web UI (Static)
      community.docker.docker_container:
        name: dearlavion-web-ui
        image: ghcr.io/dearlavion/dearlavion-web-ui:dev
        state: started
        restart_policy: always
        ports:
          - "80:80"
      when: deploy_service == "web-ui" and (use_registry | bool)


    # ----------------------------
    # Deploy nginx role
    # ----------------------------
    - name: Deploy nginx reverse proxy
      include_role:
        name: nginx

    # ----------------------------
    # Optional ngrok
    # ----------------------------
    - name: Run ngrok role if enabled
      include_role:
        name: ngrok
      when: use_ngrok | default(false)
