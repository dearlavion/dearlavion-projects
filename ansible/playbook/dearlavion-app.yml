- name: Setup DearLavion App DEV environment (Ubuntu)
  hosts: dearlavion-app_{{ env }}
  become: false
  gather_facts: yes

  tasks:
    # ----------------------------
    # Load env-specific variables
    # ----------------------------
    - name: Load environment-specific variables
      include_vars:
        file: "../group_vars/dearlavion-app_{{ env }}.yml"

    # ----------------------------
    # Passwordless sudo
    # ----------------------------
    - name: Ensure baish has passwordless sudo
      become: true
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^baish ALL=.*NOPASSWD:ALL'
        line: 'baish ALL=(ALL) NOPASSWD:ALL'
        validate: '/usr/sbin/visudo -cf %s'

    # ----------------------------
    # System packages
    # ----------------------------
    - name: Update apt cache
      become: true
      apt:
        update_cache: yes

    - name: Ensure Python3 and pip3 are installed
      become: true
      apt:
        name:
          - python3
          - python3-pip
        state: present

    # ----------------------------
    # Docker
    # ----------------------------
    - name: Ensure Docker is installed
      become: true
      apt:
        name: docker.io
        state: present

    - name: Add user to docker group
      become: true
      user:
        name: baish
        groups: docker
        append: yes

    # ----------------------------
    # Docker Compose v2
    # ----------------------------
    - name: Install Docker Compose CLI plugin (v2)
      become: true
      shell: |
        mkdir -p /usr/local/lib/docker/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64 \
          -o /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
      args:
        creates: /usr/local/lib/docker/cli-plugins/docker-compose

    # ----------------------------
    # Docker network for inter-container communication
    # ----------------------------
    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: dearlavion-net
        state: present

    # ----------------------------
    # Log in to GHCR on DEV server
    # ----------------------------
    - name: Log in to GHCR
      community.docker.docker_login:
        registry_url: ghcr.io
        username: baish
        password: "{{ ghcr_pat }}"

    # ----------------------------
    # Pull & run services from GHCR
    # ----------------------------
    - name: Pull and run Authentication Service
      community.docker.docker_container:
        name: dearlavion-authentication-service
        image: ghcr.io/dearlavion/dearlavion-auth-service:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
        ports:
          - "{{ auth_port }}:{{ auth_port }}" # Auth: host 8081 â†’ container 8081
      when: deploy_service == "auth" and (use_registry | bool)

    - name: Pull and run Core Service
      community.docker.docker_container:
        name: dearlavion-core-service
        image: ghcr.io/dearlavion/dearlavion-core-service:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
        ports:
          - "{{ core_port }}:{{ core_port }}"  # Core: host 8082 â†’ container 8082
      when: deploy_service == "core" and (use_registry | bool)

    - name: Pull and run Web UI
      community.docker.docker_container:
        name: dearlavion-web-ui
        image: ghcr.io/dearlavion/dearlavion-web-ui:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
      when: deploy_service == "web-ui" and (use_registry | bool)


    # ----------------------------
    # Deploy nginx role
    # ----------------------------
    - name: Deploy nginx reverse proxy
      include_role:
        name: ../roles/nginx
      when: deploy_service == "web-ui" and (use_registry | bool)

    # ----------------------------
    # ðŸ” Renew SSL certificates (safe every run)
    # ----------------------------
    - name: Encrypt certificates if needed
      become: true
      command: certbot renew
      notify: Reload nginx

    # ----------------------------
    # Redeploy nginx if requested
    # ----------------------------
    - name: Redeploy nginx (role + container)
      block:
        - name: Include nginx role
          include_role:
            name: ../roles/nginx

        - name: Redeploy nginx container
          become: true
          community.docker.docker_compose_v2:
            project_src: /opt/dearlavion
            state: present
            services:
              - nginx
            recreate: always
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Optional ngrok
    # ----------------------------
    - name: Run ngrok role if enabled
      include_role:
        name: ngrok
      when: use_ngrok | default(false)
