- name: Setup DearLavion App DEV environment (Ubuntu)
  hosts: dearlavion-app_{{ env }}
  become: false
  gather_facts: yes

  tasks:
    # ----------------------------
    # Load env-specific variables
    # ----------------------------
    - name: Load environment-specific variables
      include_vars:
        file: "../group_vars/dearlavion-app_{{ env }}.yml"

    # ----------------------------
    # Passwordless sudo
    # ----------------------------
    - name: Ensure baish has passwordless sudo
      become: true
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^baish ALL=.*NOPASSWD:ALL'
        line: 'baish ALL=(ALL) NOPASSWD:ALL'
        validate: '/usr/sbin/visudo -cf %s'

    # ----------------------------
    # System packages
    # ----------------------------
    - name: Update apt cache
      become: true
      apt:
        update_cache: yes

    - name: Ensure Python3 and pip3 are installed
      become: true
      apt:
        name:
          - python3
          - python3-pip
        state: present

    # ----------------------------
    # Docker
    # ----------------------------
    - name: Ensure Docker is installed
      become: true
      apt:
        name: docker.io
        state: present

    - name: Add user to docker group
      become: true
      user:
        name: baish
        groups: docker
        append: yes

    # ----------------------------
    # Docker Compose v2
    # ----------------------------
    - name: Install Docker Compose CLI plugin (v2)
      become: true
      shell: |
        mkdir -p /usr/local/lib/docker/cli-plugins
        curl -SL https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-x86_64 \
          -o /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
      args:
        creates: /usr/local/lib/docker/cli-plugins/docker-compose

    # ----------------------------
    # Docker network for inter-container communication
    # ----------------------------
    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: dearlavion-net
        state: present

    # ----------------------------
    # Log in to GHCR on DEV server
    # ----------------------------
    - name: Log in to GHCR
      community.docker.docker_login:
        registry_url: ghcr.io
        username: baish
        password: "{{ ghcr_pat }}"

    # ----------------------------
    # Pull & run services from GHCR
    # ----------------------------
    - name: Pull and run Authentication Service
      community.docker.docker_container:
        name: dearlavion-authentication-service
        image: ghcr.io/dearlavion/dearlavion-auth-service:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
        dns:
          - 8.8.8.8
          - 1.1.1.1
        env:
          - MONGO_URI: "mongodb+srv://admin:admin@dearlavioncluster.xnanadi.mongodb.net/authentication-service?retryWrites=true&w=majority&appName=DearLavionCluster"
          - JAVA_OPTS: "-Djava.net.preferIPv4Stack=true"
        ports:
          - "{{ auth_port }}:{{ auth_port }}" # Auth: host 8081 ‚Üí container 8081
      when: deploy_service == "auth" and (use_registry | bool)

    - name: Pull and run Core Service
      community.docker.docker_container:
        name: dearlavion-core-service
        image: ghcr.io/dearlavion/dearlavion-core-service:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
        ports:
          - "{{ core_port }}:{{ core_port }}"  # Core: host 8082 ‚Üí container 8082
        env:
          MONGO_URI: "mongodb+srv://admin:admin@dearlavioncluster.xnanadi.mongodb.net/authentication-service?retryWrites=true&w=majority&appName=DearLavionCluster"
      when: deploy_service == "core" and (use_registry | bool)

    - name: Pull and run Web UI
      community.docker.docker_container:
        name: dearlavion-web-ui
        image: ghcr.io/dearlavion/dearlavion-web-ui:dev
        pull: yes            # <-- always pull the latest image
        state: started     # <-- restart container even if it exists
        restart_policy: always
        networks:
          - name: dearlavion-net
      when: deploy_service == "web-ui" and (use_registry | bool)

    # ----------------------------
    # Ensure Certbot is installed
    # ----------------------------
    - name: Ensure certbot is installed
      become: true
      apt:
        name: certbot
        state: present
        update_cache: true
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Ensure webroot exists for ACME challenge
    # ----------------------------
    - name: Ensure webroot exists for ACME challenge
      become: true
      file:
        path: /opt/dearlavion/certbot-webroot
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Fix ownership for Certbot
    # ----------------------------
    - name: Ensure certbot webroot has correct ownership
      become: true
      file:
        path: /opt/dearlavion/certbot-webroot
        owner: 1000
        group: 1000
        recurse: yes
      when: rebuild_nginx | default(false) | bool

    - name: Remove temporary Nginx container
      become: true
      community.docker.docker_container:
        name: dearlavion-nginx-temp
        state: absent
        force_kill: yes

    - name: Render temporary Nginx template for Certbot
      become: true
      template:
        src: ../roles/nginx/files/nginx/temp-certbot.conf
        dest: /opt/dearlavion/nginx/temp-certbot.conf
      when: rebuild_nginx | default(false) | bool

    - name: Stop main Nginx temporarily
      community.docker.docker_container:
        name: dearlavion-nginx
        state: stopped
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Deploy minimal Nginx for Certbot
    # ----------------------------
    - name: Run temporary Nginx with docker run
      shell: |
        docker rm -f dearlavion-nginx-temp || true
        docker run -d \
          --name dearlavion-nginx-temp \
          -p 80:80 \
          --network dearlavion-net \
          -v /opt/dearlavion/certbot-webroot:/var/www/certbot:rw \
          -v /opt/dearlavion/nginx/temp-certbot.conf:/etc/nginx/conf.d/default.conf:ro \
          nginx:1.25-alpine
      when: rebuild_nginx | default(false) | bool
    #- name: Deploy temporary Nginx for ACME challenge
    #  become: true
    #  community.docker.docker_container:
    #    name: dearlavion-nginx-temp
    #    image: nginx:1.25-alpine
    #    state: started
    #    restart_policy: no
    #    ports:
    #      - "80:80"
    #    volumes:
    #      - source: /opt/dearlavion/certbot-webroot
    #        target: /var/www/certbot
    #        mode: rw
    #      - source: /opt/dearlavion/nginx/temp-certbot.conf
    #        target: /etc/nginx/conf.d/default.conf
    #        mode: ro
    #    recreate: yes
    #    networks:
    #      - name: dearlavion-net
    #  when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # üîê Renew SSL certificates (safe every run)
    # ----------------------------
    - name: Obtain or renew SSL certificates
      become: true
      command: >
        certbot certonly --webroot
        -w /opt/dearlavion/certbot-webroot
        {% for domain in server_names %}-d {{ domain }} {% endfor %}
        --non-interactive
        --agree-tos
        -m {{ email }}
      args:
        creates: "/etc/letsencrypt/live/{{ server_names[0] }}/fullchain.pem"
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Remove temporary Nginx
    # ----------------------------
    - name: Remove temporary Nginx container
      become: true
      community.docker.docker_container:
        name: dearlavion-nginx-temp
        state: absent
        force_kill: yes
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # Redeploy nginx
    # ----------------------------
    - name: Redeploy nginx (role + container)
      block:
        - name: Include nginx role
          include_role:
            name: ../roles/nginx

        - name: Redeploy nginx container
          become: true
          community.docker.docker_compose_v2:
            project_src: /opt/dearlavion
            state: present
            services:
              - nginx
            recreate: always

        - name: Reload nginx
          command: docker exec dearlavion-nginx nginx -s reload
          become: true
      when: rebuild_nginx | default(false) | bool

    # ----------------------------
    # üîê Renew SSL certificates
    # ----------------------------
    - name: Renew Let's Encrypt certificates (if needed)
      become: true
      command: certbot renew
      register: certbot_result
      changed_when: "'Congratulations' in certbot_result.stdout"
      when: renew_cert | default(false) | bool

    # ----------------------------
    # üîÑ Reload nginx if cert was renewed
    # ----------------------------
    - name: Reload nginx to apply renewed certificates
      become: true
      command: docker exec {{ nginx_container_name }} nginx -s reload
      when:
        - renew_cert | default(false) | bool
        - certbot_result is changed